<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAINEL DE PRODUÇÃO VIRABREQUIM RVR</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .sector-list li {
            font-size: 0.875rem;
        }
        .button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .refresh-btn {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .refresh-btn:hover {
            background-color: #2563eb;
        }
        .logout-btn {
            background-color: #ef4444;
            color: #ffffff;
        }
        .logout-btn:hover {
            background-color: #dc2626;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .blink {
            animation: blinker 1s linear infinite;
        }
        @keyframes blinker {
            50% { opacity: 0; }
        }
        .os-card {
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="p-6 md:p-10">

    <!-- Header Section -->
    <header class="flex flex-col md:flex-row items-center justify-between gap-4 mb-10">
        <div class="flex items-center gap-4">
            <!-- Logo RVR Virabrequim -->
            <img src="https://raw.githubusercontent.com/MLDGP1977SENAIRVR/painel-virabrequim/main/logo.png" alt="Logo Virabrequim RVR" width="64" height="64" class="h-16 w-16">
            <h1 class="text-3xl font-bold text-gray-800 text-center md:text-left">PAINEL DE PRODUÇÃO VIRABREQUIM RVR</h1>
        </div>
        <div class="flex items-center gap-4">
            <button id="refresh-button" class="button refresh-btn flex items-center gap-2">
                <span id="refresh-text">Atualizar</span>
                <span id="countdown"></span>
            </button>
            <button id="logout-button" class="button logout-btn">
                Delogar
            </button>
        </div>
    </header>

    <!-- Main Content - Cards Section -->
    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Card: Total de OS (Orçamento) -->
        <div class="card">
            <h2 class="text-2xl font-bold text-blue-600 text-center">Total de OS (Orçamento)</h2>
            <p id="orcamento-count" class="text-5xl font-extrabold text-blue-600 text-center">Carregando...</p>
            <div>
                <h3 class="text-lg font-semibold text-gray-600 mb-2">OS por Setor:</h3>
                <ul id="orcamento-setores" class="sector-list list-disc ml-5">
                    <li>Carregando...</li>
                </ul>
            </div>
        </div>

        <!-- Card: Total de OS Produção -->
        <div class="card">
            <h2 class="text-2xl font-bold text-green-600 text-center">Total de OS Produção</h2>
            <p id="producao-count" class="text-5xl font-extrabold text-green-600 text-center">Carregando...</p>
            <div>
                <h3 class="text-lg font-semibold text-gray-600 mb-2">OS por Setor:</h3>
                <ul id="producao-setores" class="sector-list list-disc ml-5">
                    <li>Carregando...</li>
                </ul>
            </div>
        </div>

        <!-- Card: Total de OS Ativas -->
        <div class="card">
            <h2 class="text-2xl font-bold text-purple-600 text-center">Total de OS Ativas</h2>
            <p id="ativas-count" class="text-5xl font-extrabold text-purple-600 text-center">Carregando...</p>
            <div>
                <h3 class="text-lg font-semibold text-gray-600 mb-2">OS por Setor:</h3>
                <ul id="ativas-setores" class="sector-list list-disc ml-5">
                    <li>Carregando...</li>
                </ul>
            </div>
        </div>
    </main>
    
    <!-- Operator Status Section -->
    <section class="mt-10">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Status Geral dos Operadores</h2>
        <div id="operadores-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- Operator cards will be dynamically added here -->
            <div class="card">
                <p>Carregando...</p>
            </div>
        </div>
    </section>

    <!-- New: Detailed OS Information Section -->
    <section class="mt-10">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Detalhes das Ordens de Serviço</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Orçamento Column -->
            <div>
                <h3 class="text-xl font-bold text-blue-600 mb-4 text-center">Ordem de Serviço - Orçamento</h3>
                <div id="orcamento-details-container" class="space-y-4">
                    <!-- OS cards will be dynamically added here -->
                    <div class="card os-card"><p>Carregando detalhes...</p></div>
                </div>
            </div>
            <!-- Produção Column -->
            <div>
                <h3 class="text-xl font-bold text-green-600 mb-4 text-center">Ordem de Serviço - Produção</h3>
                <div id="producao-details-container" class="space-y-4">
                    <!-- OS cards will be dynamically added here -->
                    <div class="card os-card"><p>Carregando detalhes...</p></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Message Box for user feedback -->
    <div id="message-box" class="mt-8 p-4 rounded-lg text-sm transition-opacity duration-300 opacity-0"></div>

    <script>
        const SPREADSHEET_URL = "https://script.google.com/macros/s/AKfycbynBnElhDQ2l1AkKZdWShcFkaRLubEiX4cSfA6tkWLbSUqsG_kaYhnOZLQMyN70sJQn/exec";
        const UPDATE_INTERVAL = 30; // 30 segundos

        const refreshButton = document.getElementById('refresh-button');
        const refreshText = document.getElementById('refresh-text');
        const countdownElement = document.getElementById('countdown');
        const orcamentoCountEl = document.getElementById('orcamento-count');
        const producaoCountEl = document.getElementById('producao-count');
        const ativasCountEl = document.getElementById('ativas-count');
        const orcamentoSetoresEl = document.getElementById('orcamento-setores');
        const producaoSetoresEl = document.getElementById('producao-setores');
        const ativasSetoresEl = document.getElementById('ativas-setores');
        const operadoresContainerEl = document.getElementById('operadores-container');
        const orcamentoDetailsContainer = document.getElementById('orcamento-details-container');
        const producaoDetailsContainer = document.getElementById('producao-details-container');
        const messageBox = document.getElementById('message-box');

        let countdown = UPDATE_INTERVAL;
        let countdownInterval;

        // Mapeamento de setores para cores Tailwind
        const SECTOR_COLORS = {
            'Adm Entrada ou Administrativo': 'text-blue-500',
            'Lavagem': 'text-sky-500',
            'Virabrequim': 'text-blue-800',
            'Bloco': 'text-green-900',
            'Biela': 'text-red-900',
            'Bielas': 'text-red-900',
            'Cabeçote': 'text-violet-900',
            'Almoxarifado': 'text-amber-500',
            'Aprovação': 'text-lime-600',
            'Montagem': 'text-emerald-500',
            'Sem Setor': 'text-gray-500'
        };

        const showMessage = (message, type) => {
            messageBox.textContent = message;
            messageBox.classList.remove('opacity-0', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800', 'opacity-100');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800', 'opacity-100');
            }
        };

        const fetchData = async () => {
            try {
                refreshButton.disabled = true;
                refreshText.innerHTML = `<span class="spinner"></span> Atualizando...`;
                messageBox.classList.remove('opacity-100');
                
                const allCards = [orcamentoCountEl, producaoCountEl, ativasCountEl, orcamentoSetoresEl, producaoSetoresEl, ativasSetoresEl];
                allCards.forEach(el => {
                    el.textContent = 'Carregando...';
                    if (el.tagName === 'UL') el.innerHTML = '<li>Carregando...</li>';
                });
                operadoresContainerEl.innerHTML = '<div class="card"><p>Carregando...</p></div>';
                orcamentoDetailsContainer.innerHTML = '<div class="card os-card"><p>Carregando detalhes...</p></div>';
                producaoDetailsContainer.innerHTML = '<div class="card os-card"><p>Carregando detalhes...</p></div>';


                const response = await fetch(SPREADSHEET_URL);
                if (!response.ok) {
                    throw new Error('Falha ao buscar dados da planilha.');
                }
                const data = await response.json();
                
                processData(data);
                showMessage('Dados atualizados com sucesso!', 'success');
            } catch (error) {
                console.error("Falha ao buscar dados:", error);
                if (error.message.includes('Failed to fetch')) {
                    showMessage('Erro: Não foi possível conectar ao seu script. Verifique se a URL da sua implantação está correta e se as permissões de acesso estão configuradas para "Qualquer pessoa".', 'error');
                } else {
                    showMessage('Erro ao carregar dados. Verifique a conexão ou a URL do script.', 'error');
                }
            } finally {
                refreshButton.disabled = false;
                refreshText.innerHTML = `Atualizar`;
            }
        };

        const processData = (data) => {
            const osData = data.slice(1);
            
            let totalOrcamentoCount = 0;
            let totalProducaoCount = 0;
            const orcamentoSetores = {};
            const producaoSetores = {};
            const ativasSetores = {};
            const operadoresData = {};
            const orcamentoDetails = [];
            const producaoDetails = [];


            osData.forEach(row => {
                const statusFinalizacao = (row[13] || '').trim().toLowerCase();
                const statusOrcamento = (row[8] || '').trim().toLowerCase();
                const setor = (row[9] || 'Sem Setor').trim();
                const operador = (row[17] || 'Sem Operador').trim() || 'Sem Operador';
                const prioridade = (row[14] || 'Sem Prioridade').trim();
                
                const osDetalhes = {
                    numero: row[1] || 'N/A',
                    sequencia: row[0] || 'N/A',
                    setor: setor,
                    prioridade: row[14] || 'N/A',
                    dataAgendamento: row[4] || 'N/A',
                    cliente: row[5] || 'N/A',
                    placa: row[8] || 'N/A',
                    motor: row[6] || 'N/A',
                    numeroMotor: row[7] || 'N/A',
                    ficha: row[11] || 'N/A',
                    tipo: row[10] || 'N/A',
                    operador: row[17] || 'N/A',
                    observacao: row[15] || 'N/A'
                };
                
                osDetalhes.veiculo = 'N/A';
                
                if (!operadoresData[operador]) {
                    operadoresData[operador] = {
                        total: 0,
                        producao: 0,
                        orcamento: 0,
                        prioridades: {
                            'Hoje': 0,
                            'Alta': 0,
                            'Média': 0,
                            'Baixa': 0
                        }
                    };
                }
                operadoresData[operador].total++;

                if (statusFinalizacao !== 'finalizado ok' && statusFinalizacao !== 'orçamento ok') {
                    ativasSetores[setor] = (ativasSetores[setor] || 0) + 1;

                    if (statusOrcamento.includes('orçamento')) {
                        orcamentoDetails.push(osDetalhes);
                    } else {
                        producaoDetails.push(osDetalhes);
                    }

                    if (statusOrcamento.includes('orçamento')) {
                        totalOrcamentoCount++;
                        orcamentoSetores[setor] = (orcamentoSetores[setor] || 0) + 1;
                        operadoresData[operador].orcamento++;
                    } else {
                        totalProducaoCount++;
                        producaoSetores[setor] = (producaoSetores[setor] || 0) + 1;
                        operadoresData[operador].producao++;
                    }

                    if (prioridade in operadoresData[operador].prioridades) {
                        operadoresData[operador].prioridades[prioridade]++;
                    }
                }
            });
            
            orcamentoDetails.sort((a, b) => parseInt(a.sequencia, 10) - parseInt(b.sequencia, 10));
            producaoDetails.sort((a, b) => parseInt(a.sequencia, 10) - parseInt(b.sequencia, 10));

            const totalAtivasCount = Object.values(ativasSetores).reduce((sum, count) => sum + count, 0);

            updateUI({
                totalAtivasCount,
                totalOrcamentoCount,
                totalProducaoCount,
                orcamentoSetores,
                producaoSetores,
                ativasSetores,
                operadoresData,
                orcamentoDetails,
                producaoDetails
            });
        };

        const formatDate = (dateString) => {
            const trimmedString = dateString?.trim();
            if (!trimmedString) {
                return 'N/A';
            }
            try {
                const date = new Date(trimmedString);
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                return date.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                console.error("Erro ao formatar a data:", dateString, e);
                return 'N/A';
            }
        };

        const updateUI = ({ totalAtivasCount, totalOrcamentoCount, totalProducaoCount, orcamentoSetores, producaoSetores, ativasSetores, operadoresData, orcamentoDetails, producaoDetails }) => {
            ativasCountEl.textContent = totalAtivasCount;
            orcamentoCountEl.textContent = totalOrcamentoCount;
            producaoCountEl.textContent = totalProducaoCount;

            orcamentoSetoresEl.innerHTML = '';
            Object.keys(orcamentoSetores).forEach(setor => {
                const li = document.createElement('li');
                li.className = SECTOR_COLORS[setor] || 'text-gray-600';
                li.textContent = `${setor}: ${orcamentoSetores[setor]}`;
                orcamentoSetoresEl.appendChild(li);
            });
            if (Object.keys(orcamentoSetores).length === 0) {
                orcamentoSetoresEl.innerHTML = '<li>Nenhuma OS de orçamento encontrada.</li>';
            }

            producaoSetoresEl.innerHTML = '';
            Object.keys(producaoSetores).forEach(setor => {
                const li = document.createElement('li');
                li.className = SECTOR_COLORS[setor] || 'text-gray-600';
                li.textContent = `${setor}: ${producaoSetores[setor]}`;
                producaoSetoresEl.appendChild(li);
            });
            if (Object.keys(producaoSetores).length === 0) {
                producaoSetoresEl.innerHTML = '<li>Nenhuma OS de produção encontrada.</li>';
            }
            
            ativasSetoresEl.innerHTML = '';
            Object.keys(ativasSetores).forEach(setor => {
                const li = document.createElement('li');
                li.className = SECTOR_COLORS[setor] || 'text-gray-600';
                li.textContent = `${setor}: ${ativasSetores[setor]}`;
                ativasSetoresEl.appendChild(li);
            });
            if (Object.keys(ativasSetores).length === 0) {
                ativasSetoresEl.innerHTML = '<li>Nenhuma OS ativa encontrada.</li>';
            }

            operadoresContainerEl.innerHTML = '';
            if (Object.keys(operadoresData).length === 0) {
                operadoresContainerEl.innerHTML = '<div class="card"><p>Nenhum operador encontrado.</p></div>';
            } else {
                Object.keys(operadoresData).forEach(operador => {
                    const data = operadoresData[operador];
                    const prioridadesHtml = `
                        <div class="grid grid-cols-2 gap-x-4">
                            <div>
                                <p class="text-sm mb-1">
                                    <span class="font-bold text-red-500">${data.prioridades['Hoje']}</span> Hoje
                                </p>
                                <p class="text-sm">
                                    <span class="font-bold text-yellow-500">${data.prioridades['Alta']}</span> Alta
                                </p>
                            </div>
                            <div>
                                <p class="text-sm mb-1">
                                    <span class="font-bold text-gray-500">${data.prioridades['Média']}</span> Média
                                </p>
                                <p class="text-sm">
                                    <span class="font-bold text-gray-500">${data.prioridades['Baixa']}</span> Baixa
                                </p>
                            </div>
                        </div>
                    `;
                    
                    const cardHtml = `
                        <div class="card">
                            <h3 class="text-xl font-bold text-gray-700 text-center">${operador}</h3>
                            <h4 class="text-sm font-semibold text-gray-500 text-center mb-4">Volume Total de OS: <span class="text-gray-800 font-bold">${data.total}</span></h4>
                            <div class="flex flex-col items-center justify-center gap-2 text-center text-sm">
                                <h4 class="text-md font-semibold text-gray-600">Abertas:</h4>
                                <div class="flex items-center justify-center gap-4">
                                    <p>
                                        <span class="font-bold text-green-600">${data.producao}</span> OS Produção
                                    </p>
                                    <p>|</p>
                                    <p>
                                        <span class="font-bold text-blue-600">${data.orcamento}</span> OS Orçamento
                                    </p>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-md font-semibold text-gray-600 mb-1">Prioridade:</h4>
                                ${prioridadesHtml}
                            </div>
                        </div>
                    `;
                    operadoresContainerEl.innerHTML += cardHtml;
                });
            }
            
            renderOSDetails(orcamentoDetails, orcamentoDetailsContainer, 'orçamento');
            renderOSDetails(producaoDetails, producaoDetailsContainer, 'produção');
        };
        
        const renderOSDetails = (details, container, type) => {
            container.innerHTML = '';
            if (details.length === 0) {
                container.innerHTML = `<div class="card os-card"><p class="text-blue-800">Nenhuma OS de ${type} encontrada.</p></div>`;
                return;
            }
            
            details.forEach(os => {
                const dataFormatada = formatDate(os.dataAgendamento);
                
                let cardTextColorClass = 'text-blue-800';
                if (os.setor === 'Biela' || os.setor === 'Bielas') {
                    cardTextColorClass = 'text-red-900';
                } else if (os.setor === 'Bloco') {
                    cardTextColorClass = 'text-green-900';
                } else if (os.setor === 'Cabeçote') {
                    cardTextColorClass = 'text-violet-900';
                }


                let cardColorClass = 'bg-gray-50 border-gray-200';
                if (os.prioridade === 'Hoje') {
                    cardColorClass = 'bg-orange-100 border-orange-400';
                } else if (os.prioridade === 'Alta') {
                    cardColorClass = 'bg-yellow-100 border-yellow-400';
                }

                const cardHtml = `
                    <div class="card os-card ${cardColorClass} ${cardTextColorClass}">
                        <!-- Novo layout para o cabeçalho da OS -->
                        <div class="flex items-center gap-4 border-b-2 border-gray-200 pb-2 mb-2">
                            <h4 class="text-lg font-extrabold">OS: ${os.numero}</h4>
                            <span class="text-sm font-medium">Sequência: ${os.sequencia}</span>
                        </div>
                        <div class="text-sm font-semibold mb-2">
                            <p><span>Setor:</span> <span class="${SECTOR_COLORS[os.setor] || 'text-gray-600'}">${os.setor}</span></p>
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <!-- Organização em duas colunas para melhor visualização -->
                            <div><span class="font-bold">Prioridade:</span> ${os.prioridade}</div>
                            <div><span class="font-bold">Data Agendamento:</span> ${dataFormatada}</div>
                            <div><span class="font-bold">Cliente:</span> ${os.cliente}</div>
                            <div><span class="font-bold">Veículo/Placa:</span> ${os.veiculo} / ${os.placa}</div>
                            <div><span class="font-bold">Motor/N° Motor:</span> ${os.motor} / ${os.numeroMotor}</div>
                            <div><span class="font-bold">Ficha/Tipo:</span> ${os.ficha} / ${os.tipo}</div>
                            <div><span class="font-bold">Operador:</span> ${os.operador}</div>
                            <div><span class="font-bold">Observação:</span> ${os.observacao}</div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        };

        const startAutoUpdate = () => {
            clearInterval(countdownInterval);
            countdown = UPDATE_INTERVAL;
            countdownElement.textContent = `(${countdown}s)`;
            countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = `(${countdown}s)`;
                if (countdown <= 0) {
                    fetchData();
                    countdown = UPDATE_INTERVAL;
                }
            }, 1000);
        };

        document.getElementById('logout-button').addEventListener('click', () => {
            window.location.reload();
        });

        refreshButton.addEventListener('click', fetchData);

        fetchData();
        startAutoUpdate();
    </script>
</body>
</html>
